# Типы данных в системе памяти Open-LLM-VTuber

## Обзор

Система памяти Open-LLM-VTuber использует несколько уровней типизации для эффективной организации и поиска информации.

## 1. Базовые типы памяти (MemoryKind)

Определены в `src/open_llm_vtuber/memory/memory_schema.py`:

```python
class MemoryKind(str, Enum):
    SELF = "self"           # Информация о Нейри
    USER = "user"           # Информация о пользователе
    THIRD_PARTY = "third_party"  # Информация о других людях
```

### Описание:
- **SELF**: Мнения, действия, состояния Нейри
- **USER**: Предпочтения, факты, поведение пользователей/зрителей
- **THIRD_PARTY**: Информация о друзьях, семье, коллегах

## 2. Типы консолидации (для долгосрочной памяти)

Используются в процессе консолидации для структурирования долгосрочной памяти:

### Основные типы:
- **FactsAboutUser** - Факты о зрителях (ник, интересы, привычки, предпочтения)
- **PastEvents** - События, произошедшие на стриме (челленджи, шутки, конфликты)
- **SelfBeliefs** - Убеждения и установки самой Нейри (о себе, своей роли)
- **Objectives** - Цели, которые Нейри поставила в ходе стрима
- **KeyFacts** - Любая важная информация для будущих стримов
- **Emotions** - Эмоции, которые испытывала Нейри или в целом
- **Mood** - Агрегированное настроение пользователей

### Дополнительные типы:
- **chat** - Общие разговоры
- **SessionEvent** - События сессии

## 3. Структура MemoryItemTyped

```python
@dataclass
class MemoryItemTyped:
    text: str                    # Основной текст памяти
    kind: MemoryKind            # Тип памяти (SELF/USER/THIRD_PARTY)
    conf_uid: str               # ID конфигурации персонажа
    history_uid: str            # ID истории диалога
    importance: float = 0.5     # Важность (0.0-1.0)
    timestamp: float = 0.0      # Временная метка
    tags: List[str] | None = None  # Теги для категоризации
    emotion: str | None = None  # Эмоциональная окраска
    context_window: str | None = None  # Контекстное окно
```

## 4. Метаданные ChromaDB

При сохранении в ChromaDB все метаданные должны быть скалярными:

```python
def to_metadata(self) -> Dict[str, Any]:
    return {
        "conf_uid": self.conf_uid,
        "history_uid": self.history_uid,
        "kind": str(self.kind.value),
        "importance": float(self.importance),
        "timestamp": float(self.timestamp),
        "tags": json.dumps(self.tags or []),  # JSON строка
        "emotion": self.emotion,              # Если есть
        "context_window": self.context_window, # Если есть
    }
```

## 5. Формат консолидации

Результат консолидации - JSON с полями:

```json
{
  "facts_about_user": ["факт1", "факт2"],
  "past_events": ["событие1", "событие2"],
  "self_beliefs": ["убеждение1", "убеждение2"],
  "objectives": ["цель1", "цель2"],
  "emotions": [
    {"name": "радость", "score": 0.8},
    {"name": "волнение", "score": 0.6}
  ],
  "key_facts": [
    {
      "text": "важный факт",
      "importance": 0.9,
      "tags": ["тег1", "тег2"]
    }
  ]
}
```

## 6. Эмоции

### Основные эмоции:
- радость, грусть, гнев, страх, удивление, отвращение
- спокойствие, волнение, любовь, стыд

### Сложные эмоции:
- ностальгия, гордость, зависть, благодарность
- разочарование, надежда, скука, интерес

### Оценка интенсивности:
- Диапазон: -1.0 (очень негативно) до +1.0 (очень позитивно)

## 7. Теги

### Категории тегов:
- **Темы и интересы**: игры, музыка, технологии, спорт, кино, книги
- **Эмоции и состояния**: радость, грусть, волнение, спокойствие, стресс
- **Социальные аспекты**: друзья, семья, коллеги, сообщество
- **Поведение и характер**: юмор, серьезность, креативность, аналитика
- **Контекст стрима**: чат, стрим, челлендж, коллаборация

## 8. Важность (importance)

- **Диапазон**: 0.0 (неважно) до 1.0 (критически важно)
- **По умолчанию**: 0.5
- **Влияет на**: приоритет при поиске, сохранение в долгосрочной памяти

## 9. Временные метки

- **Формат**: Unix timestamp (секунды с 1970 года)
- **Использование**: сортировка, фильтрация по времени, TTL

## 10. Контекстное окно

- **Назначение**: дополнительный контекст для понимания памяти
- **Примеры**: "начало стрима", "конец челленджа", "перерыв"

## Использование в коде

### Создание элемента памяти:
```python
item = MemoryItemTyped(
    text="Зритель Alex любит рок-музыку",
    kind=MemoryKind.USER,
    conf_uid="neuro_pro",
    history_uid="stream_2024_01_15",
    importance=0.7,
    tags=["музыка", "предпочтения"],
    emotion="интерес",
    context_window="обсуждение музыки"
)
```

### Определение типа памяти:
```python
kind = determine_memory_kind(
    text=input_text,
    speaker="USER",
    conf=context.character_config
)
```

### Расчет важности:
```python
importance = calculate_importance(text)
```

Эта система типов обеспечивает гибкую и эффективную организацию памяти для персонализированного взаимодействия с зрителями. 